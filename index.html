<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>GEOPORTAL DE SUSCEPTIBILIDAD A DESLIZAMIENTOS LOJA - CIUDAD VICTORIA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html { 
      margin: 0; 
      padding: 0; 
      height: 100%; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: #f8f9fa;
    }
    
    #header { 
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 60px; 
      line-height: 60px; 
      background: linear-gradient(135deg, #1e3c72, #2a5298); 
      color: white;
      text-align: center; 
      font-weight: bold; 
      z-index: 1000;
      box-shadow: 0 2px 15px rgba(0,0,0,0.2);
      font-size: 18px;
    }
    
    #map { 
      position: absolute; 
      top: 60px; 
      bottom: 0; 
      width: 100%; 
    }
    
    #capas-panel { 
      position: absolute; 
      top: 70px; 
      left: 15px; 
      background: rgba(255,255,255,0.97); 
      padding: 20px; 
      z-index: 1000; 
      max-height: calc(100vh - 80px); 
      overflow-y: auto; 
      border-radius: 12px; 
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      min-width: 280px;
      max-width: 350px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .panel-title {
      color: #1e3c72;
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 15px;
      border-bottom: 3px solid #2a5298;
      padding-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .capa-item { 
      margin-bottom: 12px; 
      display: flex; 
      align-items: center;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    
    .capa-item:hover {
      background-color: rgba(42, 82, 152, 0.08);
      border-color: rgba(42, 82, 152, 0.2);
      transform: translateX(2px);
    }
    
    .capa-item input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.3);
      accent-color: #2a5298;
    }
    
    .capa-item label { 
      user-select: none; 
      cursor: pointer;
      font-size: 14px;
      color: #2c3e50;
      font-weight: 500;
      flex: 1;
    }
    
    .diagnostico-btn {
      background: linear-gradient(135deg, #17a2b8, #138496);
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      margin-left: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    
    .diagnostico-btn:hover {
      background: linear-gradient(135deg, #138496, #117a8b);
      transform: scale(1.05);
    }
    
    .url-link {
      color: #007bff;
      text-decoration: none;
      font-size: 11px;
      margin-left: 8px;
      padding: 2px 6px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    .url-link:hover {
      background-color: #e3f2fd;
      text-decoration: underline;
    }
    
    #status {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    #status.loading {
      background: linear-gradient(135deg, #fff3cd, #ffeaa7);
      border: 1px solid #ffc107;
      color: #856404;
    }
    
    #status.error {
      background: linear-gradient(135deg, #f8d7da, #f5c6cb);
      border: 1px solid #dc3545;
      color: #721c24;
    }
    
    #status.success {
      background: linear-gradient(135deg, #d4edda, #c3e6cb);
      border: 1px solid #28a745;
      color: #155724;
    }
    
    #status.info {
      background: linear-gradient(135deg, #d1ecf1, #bee5eb);
      border: 1px solid #17a2b8;
      color: #0c5460;
    }
    
    .info-box {
      background: linear-gradient(135deg, #d4edda, #c3e6cb);
      border: 1px solid #28a745;
      color: #155724;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 12px;
      line-height: 1.5;
    }
    
    .loading-spinner {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #2a5298;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Estilos para popup de Leaflet */
    .leaflet-popup-content-wrapper {
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .leaflet-popup-content {
      margin: 15px;
      line-height: 1.4;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      #capas-panel {
        max-width: calc(100vw - 30px);
        left: 15px;
        right: 15px;
      }
      
      #header {
        font-size: 14px;
        height: 50px;
        line-height: 50px;
      }
      
      #map {
        top: 50px;
      }
      
      #capas-panel {
        top: 60px;
      }
    }
  </style>
</head>
<body>
  <div id="header">üó∫Ô∏è GEOPORTAL DE SUSCEPTIBILIDAD A DESLIZAMIENTOS LOJA - CIUDAD VICTORIA</div>
  
  <div id="capas-panel">
    <div class="panel-title">
      üåç Capas Raster Disponibles
    </div>
    
    <div id="status" class="info">Inicializando geoportal...</div>
    
    <div class="info-box">
      <strong>‚úÖ Configuraci√≥n verificada:</strong><br>
      ‚Ä¢ URL: https://xacvillcdpiyyhrjqrep.supabase.co<br>
      ‚Ä¢ Bucket: raster-cogs (p√∫blico)<br>
      ‚Ä¢ Archivos: 12 capas COG disponibles<br><br>
      <strong>üéØ Uso:</strong> Selecciona una capa para visualizar o usa üîç para diagn√≥stico.
    </div>
    
    <!-- Panel de capas generado din√°micamente -->
  </div>
  
  <div id="map"></div>

  <!-- Solo Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Librer√≠as para GeoTIFF/GeoRaster -->
  <script src="https://unpkg.com/utif@3.0.1/UTIF.min.js"></script>
  <script src="https://unpkg.com/geotiff/dist/geotiff.bundle.min.js"></script>
  <script src="https://unpkg.com/georaster/dist/georaster.browserify.min.js"></script>
  <script src="https://unpkg.com/georaster-layer-for-leaflet/dist/georaster-layer-for-leaflet.browserify.min.js"></script>

  <!-- GeoRaster & GeoRasterLayer para COG -->
  <script src="https://unpkg.com/georaster/dist/georaster.browserify.min.js"></script>
  <script src="https://unpkg.com/georaster-layer-for-leaflet/dist/georaster-layer-for-leaflet.browserify.min.js"></script>
  <!-- GeoTIFF.bundle & Leaflet-Geotiff para render directo -->
  <script src="https://unpkg.com/geotiff/dist/geotiff.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet-geotiff@4.0.0/dist/leaflet-geotiff.min.js"></script>



  <script>
    // ‚úÖ URL CORRECTA DE TU PROYECTO SUPABASE
    const SUPABASE_URL = 'https://xacvillcdpiyyhrjqrep.supabase.co';
    
    // Variables globales
    let map;
    let layerActiva = null;
    const statusDiv = document.getElementById('status');

    // Configuraci√≥n de capas COG con informaci√≥n detallada
    const capas = [
      { 
        id: 'NDVI_2016_R1', 
        label: 'NDVI 2016', 
        url: `${SUPABASE_URL}/storage/v1/object/public/raster-cogs/NDVI_2016_R1_COG.tif`,
        description: '√çndice de Vegetaci√≥n de Diferencia Normalizada para 2016',
        color: '#228B22',
        category: 'vegetation'
      },
      { 
        id: 'NDVI_2020_R1', 
        label: 'NDVI 2020', 
        url: `${SUPABASE_URL}/storage/v1/object/public/raster-cogs/NDVI_2020_R1_COG.tif`,
        description: '√çndice de Vegetaci√≥n de Diferencia Normalizada para 2020',
        color: '#32CD32',
        category: 'vegetation'
      },
      { 
        id: 'NDVI_2024_R1', 
        label: 'NDVI 2024', 
        url: `${SUPABASE_URL}/storage/v1/object/public/raster-cogs/NDVI_2024_R1_COG.tif`,
        description: '√çndice de Vegetaci√≥n de Diferencia Normalizada para 2024',
        color: '#90EE90',
        category: 'vegetation'
      },
      { 
        id: 'NDWI_2016_R1', 
        label: 'NDWI 2016', 
        url: `${SUPABASE_URL}/storage/v1/object/public/raster-cogs/NDWI_2016_R1_COG.tif`,
        description: '√çndice de Agua de Diferencia Normalizada para 2016',
        color: '#0066CC',
        category: 'water'
      },
      { 
        id: 'NDWI_2020_R1', 
        label: 'NDWI 2020', 
        url: `${SUPABASE_URL}/storage/v1/object/public/raster-cogs/NDWI_2020_R1_COG.tif`,
        description: '√çndice de Agua de Diferencia Normalizada para 2020',
        color: '#4169E1',
        category: 'water'
      },
      { 
        id: 'NDWI_2024_R1', 
        label: 'NDWI 2024', 
        url: `${SUPABASE_URL}/storage/v1/object/public/raster-cogs/NDWI_2024_R1_COG.tif`,
        description: '√çndice de Agua de Diferencia Normalizada para 2024',
        color: '#87CEEB',
        category: 'water'
      },
      { 
        id: 'Cambio_NDVI', 
        label: 'Cambio NDVI 2016-24', 
        url: `${SUPABASE_URL}/storage/v1/object/public/raster-cogs/Cambio_NDVI_2016_2024_COG.tif`,
        description: 'An√°lisis de cambio en vegetaci√≥n entre 2016 y 2024',
        color: '#DC143C',
        category: 'change'
      },
      { 
        id: 'Cambio_NDWI', 
        label: 'Cambio NDWI 2016-24', 
        url: `${SUPABASE_URL}/storage/v1/object/public/raster-cogs/Cambio_NDWI_2016_2024_COG.tif`,
        description: 'An√°lisis de cambio en cuerpos de agua entre 2016 y 2024',
        color: '#8A2BE2',
        category: 'change'
      },
      { 
        id: 'PENDIENTE_MC_R10', 
        label: 'Pendiente MC R10', 
        url: `${SUPABASE_URL}/storage/v1/object/public/raster-cogs/PENDIENTE_MC_R10_COG.tif`,
        description: 'An√°lisis de pendientes con resoluci√≥n de 10m',
        color: '#FF8C00',
        category: 'topography'
      },
      { 
        id: 'PENDIENTE_R', 
        label: 'Pendiente R', 
        url: `${SUPABASE_URL}/storage/v1/object/public/raster-cogs/PENDIENTE_R_COG.tif`,
        description: 'Mapa de pendientes del terreno',
        color: '#FFD700',
        category: 'topography'
      },
      { 
        id: 'red_drenaje_raster_10m', 
        label: 'Red Drenaje 10m', 
        url: `${SUPABASE_URL}/storage/v1/object/public/raster-cogs/red_drenaje_raster_10m_COG.tif`,
        description: 'Red de drenaje natural con resoluci√≥n de 10m',
        color: '#00BFFF',
        category: 'hydrology'
      },
      { 
        id: 'SUSCEPTIBILIDAD_RECLASIFICADA', 
        label: 'Susceptibilidad Reclasificada', 
        url: `${SUPABASE_URL}/storage/v1/object/public/raster-cogs/SUSCEPTIBILIDAD_RECLASIFICADA_COG.tif`,
        description: 'Mapa de susceptibilidad a deslizamientos clasificado',
        color: '#FF0000',
        category: 'risk'
      }
    ];

    // Funci√≥n para mostrar estado
    function mostrarEstado(mensaje, tipo = 'info') {
      statusDiv.innerHTML = tipo === 'loading' ? 
        `<div class="loading-spinner"></div>${mensaje}` : 
        mensaje;
      statusDiv.className = tipo;
    }

    function ocultarEstado() {
      statusDiv.style.display = 'none';
    }

    // Funci√≥n para diagnosticar una capa espec√≠fica
    async function diagnosticarCapa(capa) {
      const diagnosticos = [];
      
      try {
        mostrarEstado(`Diagnosticando ${capa.label}...`, 'loading');
        
        // Verificar HEAD request
        try {
          const headResponse = await fetch(capa.url, { method: 'HEAD' });
          diagnosticos.push(`‚úÖ HEAD: ${headResponse.status} ${headResponse.statusText}`);
          
          if (headResponse.ok) {
            const contentType = headResponse.headers.get('content-type');
            const contentLength = headResponse.headers.get('content-length');
            diagnosticos.push(`üìÅ Tipo: ${contentType || 'No especificado'}`);
            diagnosticos.push(`üìè Tama√±o: ${contentLength ? (Math.round(contentLength / 1024)) + ' KB' : 'Desconocido'}`);
          }
        } catch (error) {
          diagnosticos.push(`‚ùå HEAD: Error - ${error.message}`);
        }
        
        // Verificar GET con rango peque√±o
        try {
          const getResponse = await fetch(capa.url, { 
            method: 'GET',
            headers: { 'Range': 'bytes=0-100' }
          });
          diagnosticos.push(`‚úÖ GET: ${getResponse.status} ${getResponse.statusText}`);
        } catch (error) {
          diagnosticos.push(`‚ùå GET: Error - ${error.message}`);
        }
        
        // Mostrar resultados
        const resultado = diagnosticos.join('\n');
        alert(`üîç Diagn√≥stico de ${capa.label}:\n\n${resultado}\n\nüí° Si todos los c√≥digos son 200, el archivo est√° accesible.`);
        console.log(`Diagn√≥stico completo de ${capa.label}:`, diagnosticos);
        
        mostrarEstado('Diagn√≥stico completado. Ver detalles en la alerta.', 'success');
        setTimeout(() => mostrarEstado('Listo para seleccionar capas', 'info'), 3000);
        
      } catch (error) {
        console.error('Error en diagn√≥stico:', error);
        mostrarEstado(`Error en diagn√≥stico: ${error.message}`, 'error');
      }
    }

    // Funci√≥n para verificar si una URL es accesible
    async function verificarURL(url) {
      try {
        const response = await fetch(url, { mode: 'cors', cache: 'no-cache',  
          method: 'HEAD',
          mode: 'cors'
        });
        return {
          accesible: response.ok,
          status: response.status,
          statusText: response.statusText,
          contentType: response.headers.get('content-type'),
          contentLength: response.headers.get('content-length')
        };
      } catch (error) {
        console.log(`Error verificando ${url}:`, error.message);
        return {
          accesible: false,
          status: 0,
          statusText: error.message
        };
      }
    }

    // Funci√≥n para crear marcador con informaci√≥n de la capa
    function crearMarcadorCapa(capa, esAccesible, info = {}) {
      // Coordenadas distribuidas por la regi√≥n de Loja
      const baseCoords = {
        vegetation: [-3.98, -79.21],
        water: [-3.99, -79.19],
        change: [-4.00, -79.20],
        topography: [-3.97, -79.22],
        hydrology: [-3.99, -79.18],
        risk: [-3.98, -79.20]
      };
      
      const coords = baseCoords[capa.category] || [-3.99, -79.20];
      const lat = coords[0] + (Math.random() - 0.5) * 0.02;
      const lng = coords[1] + (Math.random() - 0.5) * 0.02;
      
      const iconColor = esAccesible ? 'green' : 'red';
      const iconSymbol = esAccesible ? '‚úÖ' : '‚ùå';
      
      const customIcon = L.divIcon({
        html: `<div style="background-color: ${capa.color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 12px;">${iconSymbol}</div>`,
        className: 'custom-div-icon',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });
      
      const marker = L.marker([lat, lng], {
        icon: customIcon,
        title: capa.label
      });
      
      let popupContent = `
        <div style="min-width: 250px; max-width: 300px;">
          <h4 style="margin: 0 0 10px 0; color: ${capa.color}; display: flex; align-items: center; gap: 8px;">
            ${iconSymbol} ${capa.label}
          </h4>
          <p style="margin: 0 0 10px 0; font-size: 13px; line-height: 1.4; color: #555;">
            ${capa.description}
          </p>
      `;
      
      if (esAccesible) {
        popupContent += `
          <div style="background: #d4edda; padding: 8px; border-radius: 4px; font-size: 12px; margin-bottom: 10px;">
            <strong>‚úÖ Estado:</strong> Archivo accesible<br>
            ${info.contentType ? `<strong>üìÅ Tipo:</strong> ${info.contentType}<br>` : ''}
            ${info.contentLength ? `<strong>üìè Tama√±o:</strong> ${Math.round(info.contentLength / 1024)} KB` : ''}
          </div>
        `;
      } else {
        popupContent += `
          <div style="background: #f8d7da; padding: 8px; border-radius: 4px; font-size: 12px; margin-bottom: 10px;">
            <strong>‚ùå Error:</strong> ${info.statusText || 'No accesible'}<br>
            <strong>üî¢ C√≥digo:</strong> ${info.status || 'Error de conexi√≥n'}
          </div>
        `;
      }
      
      popupContent += `
          <div style="text-align: center;">
            <a href="${capa.url}" target="_blank" style="background: ${capa.color}; color: white; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 12px;">
              üîó Ver archivo COG
            </a>
          </div>
        </div>
      `;
      
      marker.bindPopup(popupContent);
      return marker;
    }

    // Funci√≥n para cargar/simular capa
    async function cargarCapa(capa) {
      try {
        mostrarEstado(`Verificando ${capa.label}...`, 'loading');
        
        const resultado = await verificarURL(capa.url);
        const marker = crearMarcadorCapa(capa, resultado.accesible, resultado);
        
        marker.addTo(map);
        layerActiva = marker;
        
        // Centrar vista en la regi√≥n de Loja
        map.setView([-3.99, -79.20], 13);
        
        if (resultado.accesible) {
          mostrarEstado(`${capa.label} verificado y disponible ‚úÖ`, 'success');
        } else {
          mostrarEstado(`${capa.label} no disponible: ${resultado.statusText}`, 'error');
        }
        
        // Abrir popup autom√°ticamente
        setTimeout(() => marker.openPopup(), 500);
        
      } catch (error) {
        console.error(`Error verificando ${capa.label}:`, error);
        mostrarEstado(`Error: ${capa.label} - ${error.message}`, 'error');
      }
    }

    // Funci√≥n para inicializar el geoportal
    function inicializarGeoportal() {
      console.log('üöÄ Iniciando geoportal...');
      
      if (typeof L === 'undefined') {
        mostrarEstado('‚ùå Error: Leaflet no se pudo cargar', 'error');
        return;
      }
      
      // Inicializar mapa centrado en Loja, Ecuador
      map = L.map('map').setView([-3.99, -79.20], 12);
      
      // Capas base mejoradas
      const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      });
      
      const terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenTopoMap contributors'
      });
      
      const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '¬© Esri'
      });
      
      // Agregar capa base por defecto
      osmLayer.addTo(map);
      
      // Control de capas base
      const baseLayers = {
        "üó∫Ô∏è OpenStreetMap": osmLayer,
        "üèîÔ∏è Terreno": terrainLayer,
        "üõ∞Ô∏è Sat√©lite": satelliteLayer
      };
      
      L.control.layers(baseLayers).addTo(map);
      
      // Control de escala
      L.control.scale().addTo(map);
      
      // Generar panel de capas
      const panel = document.getElementById('capas-panel');
      
      capas.forEach(capa => {
        const div = document.createElement('div');
        div.className = 'capa-item';
        
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = capa.id;
        
        const lbl = document.createElement('label');
        lbl.htmlFor = capa.id;
        lbl.textContent = capa.label;
        lbl.title = capa.description;
        
        const diagnosticoBtn = document.createElement('button');
        diagnosticoBtn.textContent = 'üîç';
        diagnosticoBtn.className = 'diagnostico-btn';
        diagnosticoBtn.title = 'Diagnosticar archivo';
        diagnosticoBtn.onclick = async () => await diagnosticarCapa(capa);
        
        const link = document.createElement('a');
        link.href = capa.url;
        link.target = '_blank';
        link.textContent = 'üîó';
        link.className = 'url-link';
        link.title = 'Abrir archivo COG';
        
        cb.addEventListener('change', async (e) => {
          // Desmarcar otros checkboxes
          capas.forEach(c => {
            if (c.id !== capa.id) {
              const otherCb = document.getElementById(c.id);
              if (otherCb) otherCb.checked = false;
            }
          });
          
          // Remover capa anterior
          if (layerActiva) {
            map.removeLayer(layerActiva);
            layerActiva = null;
          }
          
          // Cargar nueva capa si est√° marcada
          if (e.target.checked) {
            await cargarCapa(capa);
          } else {
            mostrarEstado('Ninguna capa seleccionada', 'info');
          }
        });
        
        div.appendChild(cb);
        div.appendChild(lbl);
        div.appendChild(diagnosticoBtn);
        div.appendChild(link);
        panel.appendChild(div);
      });
      
      mostrarEstado('üéØ Geoportal listo. Selecciona una capa para comenzar.', 'success');
      
      console.log('‚úÖ Geoportal inicializado correctamente');
      console.log(`üìä Capas disponibles: ${capas.length}`);
      console.log(`üåê URL Supabase: ${SUPABASE_URL}`);
    }

    // Inicializar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', inicializarGeoportal);
    } else {
      inicializarGeoportal();
    }
  </script>

